<!DOCTYPE html>
<html lang="en">
  <head>
    <title>
        SQL Notes - Q. Weng
      </title>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    
    <meta name="theme-color" content="#000000" />
    
    <meta http-equiv="window-target" content="_top" />
    
    
    <meta name="description" content="SQL Notes Window Functions A window function performs a calculation across a set of table rows that are somehow related to the current row. This is comparable to the type of calculation that can be done with an aggregate function. But ==unlike regular aggregate functions, use of a window function does not cause rows to become grouped into a single output row — the rows retain their separate identities==. Behind the scenes, the window function is able to access more than just the current row of the query result." />
    <meta name="generator" content="Hugo 0.74.3 with theme pure" />
    <title>SQL Notes - Q. Weng</title>
    
    
    <link rel="stylesheet" href="https://foxisawesome.github.io/css/style.min.f9a354d3e7069c2b675555c86f6672f0a152ef9a764068aa27f468cd308a84a0.css">
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
    <meta property="og:title" content="SQL Notes" />
<meta property="og:description" content="SQL Notes Window Functions A window function performs a calculation across a set of table rows that are somehow related to the current row. This is comparable to the type of calculation that can be done with an aggregate function. But ==unlike regular aggregate functions, use of a window function does not cause rows to become grouped into a single output row — the rows retain their separate identities==. Behind the scenes, the window function is able to access more than just the current row of the query result." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://foxisawesome.github.io/sql/sql-notes/" />
<meta property="article:published_time" content="2020-09-06T18:35:02-04:00" />
<meta property="article:modified_time" content="2020-09-06T18:35:02-04:00" />
<meta itemprop="name" content="SQL Notes">
<meta itemprop="description" content="SQL Notes Window Functions A window function performs a calculation across a set of table rows that are somehow related to the current row. This is comparable to the type of calculation that can be done with an aggregate function. But ==unlike regular aggregate functions, use of a window function does not cause rows to become grouped into a single output row — the rows retain their separate identities==. Behind the scenes, the window function is able to access more than just the current row of the query result.">
<meta itemprop="datePublished" content="2020-09-06T18:35:02-04:00" />
<meta itemprop="dateModified" content="2020-09-06T18:35:02-04:00" />
<meta itemprop="wordCount" content="3287">



<meta itemprop="keywords" content="template," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SQL Notes"/>
<meta name="twitter:description" content="SQL Notes Window Functions A window function performs a calculation across a set of table rows that are somehow related to the current row. This is comparable to the type of calculation that can be done with an aggregate function. But ==unlike regular aggregate functions, use of a window function does not cause rows to become grouped into a single output row — the rows retain their separate identities==. Behind the scenes, the window function is able to access more than just the current row of the query result."/>

    <!--[if lte IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
      <![endif]-->

    <!--[if lt IE 9]>
        <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
      <![endif]-->
  </head>

  
  

  <body class="main-center theme-white" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/foxisawesome" target="_blank">
            <img class="img-circle img-rotate" src="https://foxisawesome.github.io/avatar.png" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">Q. Weng</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md"></h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i></small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="Search" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="Type something..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">Home</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">About</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">Categories</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">Tags</span>
                </a>
            </li>
            <li class="menu-item menu-item-archives">
                <a href="/posts/">
                    <i class="icon icon-archives-fill"></i>
                  <span class="menu-title">Archives</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title"> Categories</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://foxisawesome.github.io/categories/algo/" class="category-list-link">algo</a><span class="category-list-count">93</span></li>
            <li class="category-list-item"><a href="https://foxisawesome.github.io/categories/ml/" class="category-list-link">ml</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://foxisawesome.github.io/categories/noidea/" class="category-list-link">noidea</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://foxisawesome.github.io/categories/note/" class="category-list-link">note</a><span class="category-list-count">5</span></li>
            <li class="category-list-item"><a href="https://foxisawesome.github.io/categories/sql/" class="category-list-link">sql</a><span class="category-list-count">11</span></li>
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> Tags</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/array/" class="tag-list-link">array</a><span
                    class="tag-list-count">7</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/backtracking/" class="tag-list-link">backtracking</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/bfs/" class="tag-list-link">bfs</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/binarysearch/" class="tag-list-link">binarysearch</a><span
                    class="tag-list-count">5</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/bst/" class="tag-list-link">bst</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/dfs/" class="tag-list-link">dfs</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/dp/" class="tag-list-link">dp</a><span
                    class="tag-list-count">10</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/hashtable/" class="tag-list-link">hashtable</a><span
                    class="tag-list-count">9</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/heap/" class="tag-list-link">heap</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/kmeans/" class="tag-list-link">kmeans</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/leetcode/" class="tag-list-link">leetcode</a><span
                    class="tag-list-count">100</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/linkedlist/" class="tag-list-link">linkedlist</a><span
                    class="tag-list-count">12</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/math/" class="tag-list-link">math</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/recursion/" class="tag-list-link">recursion</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/sliding_window/" class="tag-list-link">sliding_window</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/sort/" class="tag-list-link">sort</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/stack/" class="tag-list-link">stack</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/string/" class="tag-list-link">string</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/template/" class="tag-list-link">template</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/tree/" class="tag-list-link">tree</a><span
                    class="tag-list-count">17</span></li>
            
            
            <li class="tag-list-item"><a href="https://foxisawesome.github.io/tags/twopointers/" class="tag-list-link">twopointers</a><span
                    class="tag-list-count">2</span></li>
            
        </ul>

    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">Catalogue</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/sql/sql-notes/"
    >SQL Notes</a
  >
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://foxisawesome.github.io/sql/sql-notes/" class="article-date">
  <time datetime="2020-09-06 18:35:02 -0400 EDT" itemprop="datePublished">2020-09-06</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>&nbsp;
  <a class="article-category-link" href="/categories/sql/"> SQL </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/template/"> template </a>
  </span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/sql/sql-notes/#comments"
            class="article-comment-link">Comments</a></span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <h1 id="sql-notes">SQL Notes</h1>
<h2 id="window-functions">Window Functions</h2>
<p>A <em>window function</em> performs a calculation across a set of table rows that are somehow related to the current row. This is comparable to the type of calculation that can be done with an aggregate function. But ==unlike regular aggregate functions, use of a window function does not cause rows to become grouped into a single output row — the rows retain their separate identities==. Behind the scenes, the window function is able to access more than just the current row of the query result.</p>
<p>Here is an example that shows how to compare each employee&rsquo;s salary with the average salary in his or her department:</p>
<pre><code class="language-mysql">SELECT depname, empno, salary, avg(salary) OVER (PARTITION BY depname) FROM empsalary;
  depname  | empno | salary | avg          
-----------+-------+--------+------
 develop   |    11 |   5200 | 5020
 develop   |     7 |   4200 | 5020
 develop   |     9 |   4500 | 5020
 develop   |     8 |   6000 | 5020
 develop   |    10 |   5200 | 5020
 personnel |     5 |   3500 | 3700
 personnel |     2 |   3900 | 3700
 sales     |     3 |   4800 | 4866
 sales     |     1 |   5000 | 4866
 sales     |     4 |   4800 | 4866
(10 rows)
</code></pre>
<p>The first three output columns come directly from the table <code>empsalary</code>, and there is one output row for each row in the table. The fourth column represents an average taken across all the table rows that have the same <code>depname</code> value as the current row. (This actually is the same function as the regular <code>avg</code> aggregate function, but the <code>OVER</code> clause causes it to be treated as a window function and computed across an appropriate set of rows.)</p>
<p>A window function call always contains an <code>OVER</code> clause directly following the window function&rsquo;s name and argument(s). This is what syntactically distinguishes it from a regular function or aggregate function. The <code>OVER</code> clause determines exactly how the rows of the query are split up for processing by the window function. The <code>PARTITION BY</code> list within <code>OVER</code> specifies dividing the rows into groups, or partitions, that share the same values of the <code>PARTITION BY</code> expression(s). For each row, the window function is computed across the rows that fall into the same partition as the current row.</p>
<p>You can also control the order in which rows are processed by window functions using <code>ORDER BY</code> within <code>OVER</code>. (The window <code>ORDER BY</code> does not even have to match the order in which the rows are output.) Here is an example:</p>
<pre><code class="language-mysql">SELECT depname, empno, salary, rank() OVER (PARTITION BY depname ORDER BY salary DESC) FROM empsalary;
  depname  | empno | salary | rank 
-----------+-------+--------+------
 develop   |     8 |   6000 |    1
 develop   |    10 |   5200 |    2
 develop   |    11 |   5200 |    2
 develop   |     9 |   4500 |    4
 develop   |     7 |   4200 |    5
 personnel |     2 |   3900 |    1
 personnel |     5 |   3500 |    2
 sales     |     1 |   5000 |    1
 sales     |     4 |   4800 |    2
 sales     |     3 |   4800 |    2
(10 rows)
</code></pre>
<p>As shown here, the <code>rank</code> function produces a numerical rank within the current row&rsquo;s partition for each distinct <code>ORDER BY</code> value, in the order defined by the <code>ORDER BY</code> clause. <code>rank</code> needs no explicit parameter, because its behavior is entirely determined by the <code>OVER</code> clause.</p>
<p>==The rows considered by a window function are those of the &ldquo;virtual table&rdquo; produced by the query&rsquo;s <code>FROM</code> clause as filtered by its <code>WHERE</code>, <code>GROUP BY</code>, and <code>HAVING</code> clauses if any==. For example, a row removed because it does not meet the <code>WHERE</code> condition is not seen by any window function. A query can contain multiple window functions that slice up the data in different ways by means of different <code>OVER</code> clauses, but they all act on the same collection of rows defined by this virtual table.</p>
<p>We already saw that <code>ORDER BY</code> can be omitted if the ordering of rows is not important. It is also possible to omit <code>PARTITION BY</code>, in which case there is just one partition containing all the rows.</p>
<p>There is another important concept associated with window functions: for each row, there is a set of rows within its partition called its <em>window frame</em>. Many (but not all) window functions act only on the rows of the window frame, rather than of the whole partition. By default, if <code>ORDER BY</code> is supplied then the frame consists of all rows from the start of the partition up through the current row, plus any following rows that are equal to the current row according to the <code>ORDER BY</code> clause. When <code>ORDER BY</code> is omitted the default frame consists of all rows in the partition. [<a href="https://www.postgresql.org/docs/9.1/tutorial-window.html#FTN.AEN1050">1]</a> Here is an example using <code>sum</code>:</p>
<pre><code class="language-mysql">SELECT salary, sum(salary) OVER () FROM empsalary;
 salary |  sum  
--------+-------
   5200 | 47100
   5000 | 47100
   3500 | 47100
   4800 | 47100
   3900 | 47100
   4200 | 47100
   4500 | 47100
   4800 | 47100
   6000 | 47100
   5200 | 47100
(10 rows)
</code></pre>
<p>Above, since there is no <code>ORDER BY</code> in the <code>OVER</code> clause, the window frame is the same as the partition, which for lack of <code>PARTITION BY</code> is the whole table; in other words each sum is taken over the whole table and so we get the same result for each output row. But if we add an <code>ORDER BY</code> clause, we get very different results:</p>
<pre><code class="language-mysql">SELECT salary, sum(salary) OVER (ORDER BY salary) FROM empsalary;
 salary |  sum  
--------+-------
   3500 |  3500
   3900 |  7400
   4200 | 11600
   4500 | 16100
   4800 | 25700
   4800 | 25700
   5000 | 30700
   5200 | 41100
   5200 | 41100
   6000 | 47100
(10 rows)
</code></pre>
<p>Here the sum is taken from the first (lowest) salary up through the current one, ==including any duplicates of the current one (notice the results for the duplicated salaries)==.</p>
<p>Window functions are permitted only in the <code>SELECT</code> list and the <code>ORDER BY</code> clause of the query. ==They are forbidden elsewhere, such as in <code>GROUP BY</code>, <code>HAVING</code> and <code>WHERE</code> clauses. This is because they logically execute after the processing of those clauses.== ==Also, window functions execute after regular aggregate functions.== This means it is valid to include an aggregate function call in the arguments of a window function, but not vice versa.</p>
<p>If there is a need to filter or group rows after the window calculations are performed, you can use a sub-select. For example:</p>
<pre><code class="language-mysql">SELECT depname, empno, salary, enroll_date
FROM
  	(SELECT depname, empno, salary, enroll_date,
          rank() OVER (PARTITION BY depname ORDER BY salary DESC, empno) AS pos
     FROM empsalary
  	) AS ss
WHERE pos &lt; 3;
</code></pre>
<p>The above query only shows the rows from the inner query having <code>rank</code> less than 3.</p>
<p>When a query involves multiple window functions, it is possible to write out each one with a separate <code>OVER</code> clause, but this is duplicative and error-prone if the same windowing behavior is wanted for several functions. Instead, each windowing behavior can be named in a <code>WINDOW</code> clause and then referenced in <code>OVER</code>. For example:</p>
<pre><code class="language-mysql">SELECT sum(salary) OVER w, avg(salary) OVER w
FROM empsalary
WINDOW w AS (PARTITION BY depname ORDER BY salary DESC);
</code></pre>
<h2 id="some-functions">Some functions</h2>
<ol>
<li>
<p><code>ROUND(var,2)</code></p>
</li>
<li>
<p><code>IFNULL(var,0)</code></p>
</li>
<li>
<p><code>COUNT(*)</code> is all rows in the table, <code>COUNT(Expression)</code> is where the expression is non-null only.</p>
</li>
<li>
<p>DATEDIFF(date1, date2)=1`: date1 - date2 = 1 day, datediff(curdate(), data_var) &lt;= 7</p>
</li>
<li>
<p>date should use <code>purchase_date between start_date and end_date</code> instead of <code>start_date&lt;= purchase_date &lt;=end_date</code> (see LC1251)</p>
</li>
<li>
<p><strong>When you add an <code>order by</code> to an aggregate used as a window function that aggregate turns into a &ldquo;running count&rdquo; (or whatever aggregate you use).</strong> <a href="https://stackoverflow.com/questions/50945477/count-rows-in-partition-with-order-by">link</a></p>
<p>The <code>count(*)</code> will return the number of rows up until the &ldquo;current one&rdquo; based on the order specified.</p>
</li>
<li>
<p><code>2020-07-16</code> to <code>2020-07</code>  <code>LEFT(trans_date, 7) AS month</code> or <code>DATE_FORMAT(trans_date, '%Y-%m') AS month</code></p>
</li>
<li>
<p>The only difference between Union and Union All is that ==Union All will not removes duplicate rows or records==, instead, it just selects all the rows from all the tables which meets the conditions of your specifics query and combines them into the result table.</p>
</li>
<li>
<p><code>group_concat()</code></p>
<pre><code class="language-mysql">Activities table:
+------------+-------------+
| sell_date  | product     |
+------------+-------------+
| 2020-05-30 | Headphone   |
| 2020-06-01 | Pencil      |
| 2020-06-02 | Mask        |
| 2020-05-30 | Basketball  |
| 2020-06-01 | Bible       |
| 2020-06-02 | Mask        |
| 2020-05-30 | T-Shirt     |
+------------+-------------+
    
Result table:
+------------+----------+------------------------------+
| sell_date  | num_sold | products                     |
+------------+----------+------------------------------+
| 2020-05-30 | 3        | Basketball,Headphone,T-shirt |
| 2020-06-01 | 2        | Bible,Pencil                 |
| 2020-06-02 | 1        | Mask                         |
+------------+----------+------------------------------+
    
select sell_date, count(distinct product) as num_sold, 
group_concat(distinct product order by product asc separator ',') as products               
from activities  
group by sell_date
order by sell_date
</code></pre>
</li>
</ol>
<h2 id="common-table-expressions-cte">Common Table Expressions (CTE)</h2>
<pre><code class="language-mysql">WITH
  cte1 AS (SELECT a, b FROM table1),
  cte2 AS (SELECT c, d FROM table2)
  
SELECT b, d FROM cte1 JOIN cte2
WHERE cte1.a = cte2.c;
</code></pre>
<h2 id="aggregation-function">Aggregation Function</h2>
<blockquote>
<p><a href="https://leetcode.com/problems/investments-in-2016/">LC585: Investments in 2016</a></p>
<p>Write a query to print the sum of all total investment values in 2016 (<strong>TIV_2016</strong>), to a scale of 2 decimal places, for all policy holders who meet the following criteria:</p>
<ol>
<li>Have the same <strong>TIV_2015</strong> value as one or more other policyholders (none unique tiv_2015).</li>
<li>Are not located in the same city as any other policyholder (i.e.: the (latitude, longitude) attribute pairs must be unique).</li>
</ol>
</blockquote>
<pre><code class="language-mysql">select sum(TIV_2016) as TIV_2016
from insurance
where TIV_2015 in (select TIV_2015 from insurance group by TIV_2015 having sum(1)&gt;1) 
and   pid in (select pid from insurance group by CONCAT(lat, lon) having sum(1) &lt; 2)
</code></pre>
<blockquote>
<p><a href="https://leetcode.com/problems/get-the-second-most-recent-activity/">LC 1369: Get the Second Most Recent Activity</a>:
Write an SQL query to show the <strong>second most recent activity</strong> of each user.
If the user only has one activity, return that one.
A user can&rsquo;t perform more than one activity at the same time. Return the result table in <strong>any</strong> order.</p>
</blockquote>
<pre><code class="language-mysql">select username, activity, startDate, endDate  
from (
        select *, count(activity) over(partition by username) ct, 
    		row_number() over(partition by username order by startdate desc) nb_act
        from UserActivity
) a
where a.ct &lt; 2 or nb_act=2 
</code></pre>
<h2 id="rank-scores">Rank Scores</h2>
<blockquote>
<p><a href="https://leetcode.com/problems/rank-scores/">LC178: Rank Scores</a> Write a SQL query to rank scores. If there is a tie between two scores, both should have the same ranking. Note that after a tie, the next ranking number should be the next consecutive integer value. In other words, there should be no &ldquo;holes&rdquo; between ranks.</p>
</blockquote>
<pre><code class="language-mysql"># dense_rank() solution (faster):
select score, dense_rank() over(order by score desc) as rank
from scores
order by rank desc

# rank algo solution:
select score, (select count(distinct score) from scores b where b.score&gt;=a.score) as 'rank'
from scores a
order by 'rank'
</code></pre>
<blockquote>
<p><a href="https://leetcode.com/problems/department-top-three-salaries/">LC 185: Department Top Three Salaries</a> Write a SQL query to find employees who earn the top three salaries in each of the department. For the above tables, your SQL query should return the following rows (order of rows does not matter).</p>
</blockquote>
<pre><code class="language-mysql">select b.name as Department, a.name as Employee, a.Salary
from employee a
inner join department b
on a.departmentID = b.id
where 3 &gt;=
(
   select count(distinct c.salary) 
   from employee c 
   where c.salary &gt;= a.salary and c.departmentid = a.departmentid
) 
</code></pre>
<blockquote>
<p><a href="https://leetcode.com/problems/activity-participants/">LC 1355. Activity Participants</a>: Write an SQL query to find the names of all the activities with neither maximum, nor minimum number of participants.</p>
</blockquote>
<pre><code class="language-mysql">select activity 
from (
   select activity, dense_rank() over(order by count(id) desc) as rank_desc,
   dense_rank() over(order by count(id)) as rank_asc
   from friends
   group by activity
) a
where a.rank_desc != 1 and a.rank_asc != 1
</code></pre>
<h2 id="rolling-window-cumulative-sum">Rolling window, cumulative sum</h2>
<blockquote>
<p><a href="https://leetcode.com/problems/find-cumulative-salary-of-an-employee/">LC 579. Find Cumulative Salary of an Employee:</a> Write a SQL to get the cumulative sum of an employee&rsquo;s salary over a period of 3 months but exclude the most recent month.</p>
</blockquote>
<pre><code class="language-mysql">select id, month, sum(salary) over(partition by id order by month rows 2 preceding) as salary
from employee a
where a.month &lt; (select max(month) from employee where id = a.id)
order by id, month desc;
</code></pre>
<p>Note:</p>
<ol>
<li><code>sum(salary) over(partition by id order by month)</code> gives cumulative sum for each id.</li>
<li><code>sum() over(XXX rows 2 preceding)</code> gives a rolling window for sum over only 3 months. or <code>sum(salary) over(order by date desc rows between 2 preceding and current row)</code></li>
<li><code>where a.month &lt; (select max(month) from employee where id = a.id)</code> this excludes the most recent month row for each id.</li>
</ol>
<h2 id="rolling-average">Rolling Average</h2>
<blockquote>
<p><a href="https://stackoverflow.com/questions/42208761/hive-rolling-average-when-some-days-missing">hive rolling average when some days missing</a>: I am working with hive on huge dataset and trying rolling average for past one week with missing dates in the input table.</p>
</blockquote>
<pre><code class="language-mysql">select date, volume, 
avg(volume) over(order by date rows between 6 preceding and current row) as row7_avg, 
avg(volume) over(order by date range between 6 preceding and current row) as moving_avg, 
sum(volume) over(order by date range between 6 preceding and current row)/7 as avg_weekly
from job_history
</code></pre>
<p>notes:</p>
<ol>
<li>==range between== will account for missing dates</li>
<li>row between will skip missing dates, just going back 6 rows</li>
<li>avg() will skip rows not showing up in the table. one should use sum()/7 to account for weekly avg.</li>
</ol>
<h2 id="lead-function">Lead function</h2>
<blockquote>
<p><a href="https://leetcode.com/problems/active-users/">LC 1454. Active Users</a>:Write an SQL query to find the id and the name of active users. Active users are those who logged in to their accounts for 5 or more consecutive days. Return the result table <strong>ordered</strong> by the id.</p>
</blockquote>
<pre><code class="language-mysql">select distinct a.id, a.name
from accounts a
join (
    select id, login_date, 
    lead(login_date,4) over(partition by id order by login_date) as lead_date
    from (select distinct id, login_date from logins) c
)  b
on a.id = b.id
where datediff(lead_date, login_date) = 4  
order by 1
</code></pre>
<p>Note:</p>
<ol>
<li><code>lead(date)</code> need to accompany with <code>partition by</code> and <code>order by</code> same time in line 5</li>
<li>consecutive algo is using <code>lead()</code> with <code>datediff()</code> in line 9</li>
</ol>
<h2 id="self-join-no-duplicates">Self Join no duplicates</h2>
<blockquote>
<p>What we have: [A1, A2, A3, B1, B2, C1, C2]. what to archive: [A1 A2, A1 A3, A2 A3, B1 B2, C1 C2]</p>
</blockquote>
<pre><code class="language-mysql">SELECT mytable.*, self.* 
FROM mytable 
INNER JOIN mytable AS self 
ON (mytable.letter = self.letter and mytable.number &gt; self.number)
</code></pre>
<p>Notes: self join use <code>inner join</code>, <code>mytable.number &gt; self.number</code> do not use != to avoid duplicated rows.</p>
<blockquote>
<p><a href="https://leetcode.com/problems/duplicate-emails/">LC 182. Duplicate Emails:</a></p>
</blockquote>
<pre><code class="language-mysql">select distinct a.email
from person a
inner join person b
on a.id &gt; b.id and a.email = b.email
</code></pre>
<h2 id="consecutive-rows">Consecutive rows</h2>
<blockquote>
<p><a href="https://leetcode.com/problems/consecutive-available-seats/">LC 603. Consecutive Available Seats</a>
Several friends at a cinema ticket office would like to reserve consecutive available seats. Can you help to query all the consecutive available seats order by the seat_id using the following <code>cinema</code> table?</p>
</blockquote>
<pre><code class="language-mysql">select distinct a.seat_id
from cinema a 
join cinema b
on abs(a.seat_id - b.seat_id) = 1 and a.free = 1 and b.free = 1
order by a.seat_id
</code></pre>
<p>Note: 1. self join; 2. id - 1, id + 1</p>
<h2 id="some-good-excises">Some good excises</h2>
<blockquote>
<p><a href="https://leetcode.com/problems/exchange-seats/">LC 626. Exchange Seats</a>: Mary is a teacher in a middle school and she has a table <code>seat</code> storing students&rsquo; names and their corresponding seat ids. The column <strong>id</strong> is continuous increment. Mary wants to change seats for the adjacent students. Can you write a SQL query to output the result for Mary?</p>
</blockquote>
<pre><code class="language-mysql"># solution 1
select case when mod(id, 2) != 0 and counts != id then id +1
          when mod(id, 2) != 0 and counts = id then id
          else id - 1 end as id, student
from seat, (select count(*) as counts from seat) as seat_counts
order by id;

# solution 2
SELECT s1.id, s2.student
FROM seat s1, seat s2
WHERE (CASE WHEN s1.id%2 = 1 AND s1.id = (SELECT MAX(id) FROM seat) THEN s1.id = s2.id
    WHEN s1.id%2=0 THEN s1.id = s2.id + 1
    ELSE s2.id = s1.id +1 
     END)
ORDER BY s1.id;
</code></pre>
<p>Note:
from a, b is a implicit join, one should put on condition in where clause. if no join condition specified, then it is a cartesian join.</p>
<h2 id="outer-join">Outer join</h2>
<blockquote>
<p>We have two tables. One table has all mobile actions, i.e. all pages visited by the users on mobile. The other table has all web actions, i.e. all pages visited on web by the users.</p>
<p>Write a query that returns the percentage of users who only visited mobile, only web and both. That is, the percentage of users who are only in the mobile table, only in the web table and in both tables. The sum of the percentages should return 1.</p>
</blockquote>
<pre><code class="language-mysql">SELECT 100*SUM(CASE WHEN m.user_id IS null THEN 1 ELSE 0 END)/COUNT(*) as WEB_ONLY,
100*SUM(CASE WHEN w.user_id IS null THEN 1 ELSE 0 END)/COUNT(*) as MOBILE_ONLY,
100*SUM(CASE WHEN m.user_id IS NOT null AND w.user_id IS NOT null THEN 1 ELSE 0 END)/COUNT(*) as BOTH
FROM
(SELECT distinct user_id FROM query_two_web ) w 
FULL OUTER JOIN
(SELECT distinct user_id FROM query_two_mobile ) m 
ON m.user_id = w.user_id;
</code></pre>
<h2 id="median-algo">Median Algo</h2>
<blockquote>
<p>We have two tables. One is user id and their signup date. The other one shows all transactions done by those users, when the transaction happens and its corresponding dollar amount.</p>
<p>Find the average and median transaction amount only considering those transactions that happen on the same date as that user signed-up.</p>
</blockquote>
<pre><code class="language-mysql">row_asc | row_desc
	  1 | 5
	  2 | 4
	  3 | 3 --- row_asc is between row_desc -1 and row_desc +1 
	  4 | 2
	  5 | 1
----
SELECT AVG(transaction_amount) AS average,
AVG(CASE WHEN row_num_asc BETWEEN row_num_desc-1 and row_num_desc+1 THEN transaction_amount ELSE NULL END ) AS median 
FROM
(
SELECT transaction_amount,
	ROW_NUMBER() OVER(ORDER BY transaction_amount) row_num_asc, 
    COUNT(*) OVER() - ROW_NUMBER() OVER(ORDER BY transaction_amount) + 1 AS row_num_desc 
FROM query_five_users a
JOIN (SELECT *, to_date(transaction_date) AS date_only FROM query_five_transactions) b
ON a.user_id = b.user_id AND a.sign_up_date = b.date_only 
) tmp;
</code></pre>
<h2 id="find-country-with-minimum-and-max-accounts">Find country with minimum and max accounts</h2>
<pre><code class="language-mysql">SELECT country, user_count
FROM (
        SELECT *,
        ROW_NUMBER() OVER (ORDER BY user_count) as count_asc, 
        ROW_NUMBER() OVER (ORDER BY user_count desc) as count_desc
        FROM (
			SELECT country, COUNT(distinct user_id) as user_count FROM query_six GROUP BY country
			)a
 	) tmp
WHERE count_asc = 1 or count_desc = 1;
</code></pre>
<h2 id="find-max-or-min-from-consecutive-records">Find MAX() or MIN() from consecutive records</h2>
<p>Basic idea: <code>MAX()</code> or <code>MIN()</code> group by <code>feature - row index</code></p>
<blockquote>
<p>LC 1225. Report Contiguous Dates</p>
<p><a href="https://leetcode.com/problems/report-contiguous-dates/">https://leetcode.com/problems/report-contiguous-dates/</a></p>
</blockquote>
<pre><code class="language-mysql">WITH combined as 
(
     SELECT 
        fail_date as dt, 
        'failed' as period_state,
        DAYOFYEAR(fail_date) - row_number() over(ORDER BY fail_date) as period_group 
     FROM 
        Failed
     WHERE fail_date BETWEEN '2019-01-01' AND '2019-12-31'
     UNION ALL
     SELECT 
        success_date as dt, 
        'succeeded' as period_state,
        DAYOFYEAR(success_date) - row_number() over(ORDER BY success_date) as period_group 
     FROM Succeeded
     WHERE success_date BETWEEN '2019-01-01' AND '2019-12-31'  
)

SELECT 
    period_state,
    min(dt) as start_date,
    max(dt) as end_date
FROM
        combined
GROUP BY period_state, period_group
ORDER BY start_date
</code></pre>
<blockquote>
<p>LC 1285. Find the Start and End Number of Continuous Ranges</p>
<p><a href="https://leetcode.com/problems/find-the-start-and-end-number-of-continuous-ranges/">https://leetcode.com/problems/find-the-start-and-end-number-of-continuous-ranges/</a></p>
</blockquote>
<pre><code class="language-mysql">SELECT min(log_id) as start_id, max(log_id) as end_id
FROM
    (SELECT log_id, ROW_NUMBER() OVER(ORDER BY log_id) as num
    FROM Logs) a
GROUP BY log_id - num
</code></pre>
<h2 id="pivot-table-trick">Pivot Table Trick</h2>
<blockquote>
<pre><code>| name   | continent |
|--------|-----------|
| Jack   | America   |
| Pascal | Europe    |
| Xi     | Asia      |
| Jane   | America   |
</code></pre>
<p>to this:</p>
<pre><code>| America | Asia | Europe |
|---------|------|--------|
| Jack    | Xi   | Pascal |
| Jane    |      |        |
</code></pre>
</blockquote>
<pre><code class="language-mysql">SELECT 
MAX(CASE WHEN continent = 'America' THEN name ELSE NULL END) AS America,
MAX(CASE WHEN continent = 'Asia' THEN name ELSE NULL END) AS Asia,
MAX(CASE WHEN continent = 'Europe' THEN name ELSE NULL END) AS Europe

FROM (
    SELECT *, ROW_NUMBER() OVER(PARTITION BY continent ORDER BY NAME) AS row_id FROM student
) a
GROUP BY row_id
ORDER BY row_id
</code></pre>
<p>note:</p>
<ol>
<li><code>ROW_NUMBER()</code>  + <code>GROUP BY</code> : will give out name by continent</li>
<li><code>MAX()</code> will remove <code>NULL</code> for each continent</li>
</ol>
<h2 id="sql-function-sample">SQL function sample</h2>
<blockquote>
<p><a href="https://leetcode.com/problems/nth-highest-salary/">LC177.</a> Nth Highest Salary): Write a SQL query to get the <em>n</em>th highest salary from the <code>Employee</code> table. For example, given the above Employee table, the <em>n</em>th highest salary where <em>n</em> = 2 is <code>200</code>. If there is no <em>n</em>th highest salary, then the query should return <code>null</code>. input: {&ldquo;headers&rdquo;: {&ldquo;Employee&rdquo;: [&ldquo;Id&rdquo;, &ldquo;Salary&rdquo;]}, &ldquo;argument&rdquo;: 2, &ldquo;rows&rdquo;: {&ldquo;Employee&rdquo;: [[1, 100], [2, 200], [3, 300]]}}</p>
</blockquote>
<pre><code class="language-mysql">CREATE FUNCTION getNthHighestSalary(N INT) RETURNS INT
BEGIN
declare m int;
set m = n-1;

RETURN (
		select salary 
           from Employee
           group by salary
           order by salary desc
           limit m, 1
 );
END
</code></pre>

    </div>
    <div class="article-footer">
    </div>
  </article>
<section id="comments">
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://foxisawesome.github.io/posts/166-fraction-to-recurring-decimal/" title="166 Fraction to Recurring Decimal"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;Older</span></a>
            </li>
            <li class="next">
                <a href="https://foxisawesome.github.io/posts/1512-number-of-good-pairs/"
                    title="1512 Number of Good Pairs"><span>Newer&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="Catalogue" role="button">
                    <span>[&nbsp;</span><span>Catalogue</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/foxisawesome" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://www.linkedin.com/in/qweng/" target="_blank" title="linkedin" data-toggle=tooltip data-placement=top >
            <i class="icon icon-linkedin"></i></a></li>
    <li><a href="https://foxisawesome.github.io/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2019  -
    2020
    <div class="publishby">
        Theme by <a href="https://github.com/xiaoheiAh" target="_blank"> xiaoheiAh </a>base on<a href="https://github.com/xiaoheiAh/hugo-theme-pure" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/sql.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://foxisawesome.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://foxisawesome.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: 'Posts',
                PAGES: 'Pages',
                CATEGORIES: 'Categories',
                TAGS: 'Tags',
                UNTITLED: '(Untitled)',
            },
            ROOT_URL: 'https:\/\/foxisawesome.github.io',
            CONTENT_URL: 'https:\/\/foxisawesome.github.io\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://foxisawesome.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-176995936-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
